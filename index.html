<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>자리 뽑기 시스템</title>
  <style>
    :root {
      --seat-ratio-w: 5;
      --seat-ratio-h: 3;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f7;
      min-height: 100vh;
    }

    h1 { margin: 0 0 16px; font-size: 24px; }
    h2 { margin: 0 0 8px; font-size: 20px; }

    .section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    label { display: inline-block; margin: 4px 0; }

    input, textarea {
      padding: 4px 6px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    button {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #0070f3;
      background: #0070f3;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .grid {
      display: grid;
      gap: 4px;
      margin-top: 12px;
    }

    /* 자리 한 칸: 화면 폭에 맞게 자동 확장 */
    .seat {
      width: 100%;
      aspect-ratio: var(--seat-ratio-w) / var(--seat-ratio-h);
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      text-align: center;
      padding: 2px;
    }

    .seat.disabled { cursor: default; }
    .seat.excluded {
      background: #eee;
      border-style: dashed;
      color: #888;
    }
    .seat.assigned {
      background: #ffe08a;
      border-color: #f2b100;
      font-weight: bold;
    }

    .radio-group { margin: 8px 0; }
    .info { font-size: 13px; color: #666; }
    .hidden { display: none; }
    .screen { display: none; }
    .screen.active { display: block; }
    .status-text { margin-top: 8px; min-height: 20px; }

    /* 좌측 7 : 우측 3 */
    .layout-two-columns {
      display: grid;
      grid-template-columns: 7fr 3fr;
      gap: 24px;
      min-height: calc(100vh - 80px);
    }

    .draw-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .draw-log-container {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      margin-top: 16px;
      height: 300px;
      overflow-y: auto;
      font-size: 13px;
    }

    .draw-log-title { font-weight: bold; margin-bottom: 4px; }
    .draw-log-line { margin: 2px 0; }

    /* 모달 */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.hidden { display: none; }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    }
  </style>
</head>
<body>

  <h1>자리 뽑기 시스템</h1>

  <!-- 1. 설정 화면 -->
  <div id="screen-config" class="screen active">
    <div class="section">
      <h2>1. 자리 설정</h2>
      <label>행 수: <input type="number" id="rowsInput" min="1" value="4"></label>
      &nbsp;&nbsp;
      <label>열 수: <input type="number" id="colsInput" min="1" value="5"></label>
      <br>
      <button id="generateSeatsBtn">자리 생성</button>
      <div class="info">생성된 자리를 클릭하면 제외할 수 있습니다.</div>
      <div id="seatGridConfig" class="grid"></div>
    </div>

    <div class="section">
      <h2>2. 학생 입력하기</h2>

      <div class="radio-group">
        <label><input type="radio" name="studentMode" value="number"> 번호로 뽑기</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="studentMode" value="name"> 이름으로 뽑기</label>
      </div>

      <div id="studentNumberSection" class="hidden">
        <label>시작 번호: <input type="number" id="startNumberInput"></label>
        &nbsp;
        <label>끝 번호: <input type="number" id="endNumberInput"></label>
        <br>
        <label>제외 번호: <input type="text" id="excludeNumbersInput" placeholder="예: 3,7,12"></label>
      </div>

      <div id="studentNameSection" class="hidden">
        <label>이름 리스트(콤마로 구분):</label>
        <textarea id="namesInput" placeholder="예: 박민지, 이준형, 김단아"></textarea>
      </div>

      <button id="goToDrawBtn">다음 단계</button>
      <div id="configStatus" class="status-text"></div>
    </div>
  </div>

  <!-- 2. 추첨 화면 -->
  <div id="screen-draw" class="screen">
    <div class="section layout-two-columns">

      <!-- 왼쪽: 자리 배치 -->
      <div>
        <h2>3. 자리 배치</h2>
        <div id="seatGridDraw" class="grid"></div>
      </div>

      <!-- 오른쪽: 추첨 패널 -->
      <div class="draw-panel">
        <div>
          <h2>4. 추첨 진행</h2>
          <button id="drawSeatNumbersBtn">자리 번호 추첨</button><br>
          <button id="startDrawBtn" style="margin-top:8px;">추첨 시작</button>
          <div class="info">
            1) 자리 번호를 랜덤으로 부여한 뒤<br>
            2) '추첨 시작'을 누를 때마다 한 명씩 배정됩니다.
          </div>
          <div id="drawStatus" class="status-text"></div>
        </div>

        <div class="draw-log-container">
          <div class="draw-log-title">배정 내역</div>
          <div id="drawLog"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- 최종 자리 배치 모달 -->
  <div id="finalModal" class="modal hidden">
    <div class="modal-content">
      <h2>최종 자리 배치</h2>
      <div id="finalGrid" class="grid"></div>
      <button id="closeFinalModalBtn" style="margin-top:12px;">닫기</button>
    </div>
  </div>

  <script>
    // ----- 상태 -----
    const state = {
      rows: 0,
      cols: 0,
      excluded: new Set(),   // "r-c"
      mode: null,            // "number" | "name"
      students: [],
      seatNumbers: {},       // key -> seatNumber
      assignments: {},       // key -> 학생(번호/이름)
      orderedSeats: [],      // seatNumber 순으로 정렬된 좌석 목록
      shuffledStudents: [],  // 섞인 학생 배열
      index: 0,
      drawing: false
    };

    const seatKey = (r, c) => `${r}-${c}`;

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function getActiveSeats() {
      const res = [];
      for (let r = 0; r < state.rows; r++) {
        for (let c = 0; c < state.cols; c++) {
          const k = seatKey(r, c);
          if (!state.excluded.has(k)) {
            res.push({ row: r, col: c });
          }
        }
      }
      return res;
    }

    // 설정 화면용 좌석 렌더
    function renderConfigGrid() {
      const grid = document.getElementById("seatGridConfig");
      grid.innerHTML = "";
      if (!state.rows || !state.cols) return;

      grid.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;

      for (let r = 0; r < state.rows; r++) {
        for (let c = 0; c < state.cols; c++) {
          const k = seatKey(r, c);
          const div = document.createElement("div");
          div.className = "seat";
          if (state.excluded.has(k)) div.classList.add("excluded");

          div.onclick = () => {
            if (state.excluded.has(k)) {
              state.excluded.delete(k);
              div.classList.remove("excluded");
            } else {
              state.excluded.add(k);
              div.classList.add("excluded");
            }
          };

          grid.appendChild(div);
        }
      }
    }

    // 공통: 좌석 렌더 (draw 화면 / final 모달)
    function renderGridTo(elementId) {
      const grid = document.getElementById(elementId);
      grid.innerHTML = "";
      grid.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;

      for (let r = 0; r < state.rows; r++) {
        for (let c = 0; c < state.cols; c++) {
          const k = seatKey(r, c);
          const div = document.createElement("div");
          div.className = "seat disabled";

          if (state.excluded.has(k)) {
            div.classList.add("excluded");
            div.textContent = "X";
          } else {
            if (state.assignments[k]) {
              // 이미 배정된 자리 → 학생 표시
              div.classList.add("assigned");
              div.textContent = state.assignments[k];
            } else if (state.seatNumbers[k]) {
              // 아직 배정 안 된 자리 → 자리 번호 표시
              div.textContent = state.seatNumbers[k];
            } else {
              // 아직 번호도 없는 경우
              div.textContent = "";
            }
          }

          grid.appendChild(div);
        }
      }
    }

    function showFinalModal() {
      renderGridTo("finalGrid");
      document.getElementById("finalModal").classList.remove("hidden");
    }

    function resetAll() {
      state.rows = 0;
      state.cols = 0;
      state.excluded = new Set();
      state.mode = null;
      state.students = [];
      state.seatNumbers = {};
      state.assignments = {};
      state.orderedSeats = [];
      state.shuffledStudents = [];
      state.index = 0;
      state.drawing = false;

      document.getElementById("rowsInput").value = 4;
      document.getElementById("colsInput").value = 5;
      document.getElementById("seatGridConfig").innerHTML = "";
      document.getElementById("configStatus").textContent = "";
      document.getElementById("drawStatus").textContent = "";
      document.getElementById("drawLog").innerHTML = "";

      document.getElementById("studentNumberSection").classList.add("hidden");
      document.getElementById("studentNameSection").classList.add("hidden");
      document.querySelectorAll("input[name='studentMode']").forEach(r => r.checked = false);

      document.getElementById("finalModal").classList.add("hidden");
      document.getElementById("screen-config").classList.add("active");
      document.getElementById("screen-draw").classList.remove("active");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const rowsInput = document.getElementById("rowsInput");
      const colsInput = document.getElementById("colsInput");
      const generateSeatsBtn = document.getElementById("generateSeatsBtn");
      const goToDrawBtn = document.getElementById("goToDrawBtn");
      const configStatus = document.getElementById("configStatus");

      const drawSeatNumbersBtn = document.getElementById("drawSeatNumbersBtn");
      const startDrawBtn = document.getElementById("startDrawBtn");
      const drawStatus = document.getElementById("drawStatus");
      const drawLog = document.getElementById("drawLog");

      const finalModal = document.getElementById("finalModal");
      const closeFinalModalBtn = document.getElementById("closeFinalModalBtn");

      // 학생 입력 모드 선택
      document.querySelectorAll("input[name='studentMode']").forEach(r => {
        r.addEventListener("change", e => {
          state.mode = e.target.value;
          if (state.mode === "number") {
            document.getElementById("studentNumberSection").classList.remove("hidden");
            document.getElementById("studentNameSection").classList.add("hidden");
          } else {
            document.getElementById("studentNameSection").classList.remove("hidden");
            document.getElementById("studentNumberSection").classList.add("hidden");
          }
        });
      });

      // 자리 생성
      generateSeatsBtn.onclick = () => {
        const rows = parseInt(rowsInput.value, 10);
        const cols = parseInt(colsInput.value, 10);

        if (!rows || !cols || rows <= 0 || cols <= 0) {
          alert("행과 열을 올바르게 입력하세요.");
          return;
        }

        state.rows = rows;
        state.cols = cols;
        state.excluded = new Set();

        configStatus.textContent = "자리가 생성되었습니다. 제외할 자리를 클릭해서 선택하세요.";
        renderConfigGrid();
      };

      // 다음 단계 (학생 수 검증)
      goToDrawBtn.onclick = () => {
        if (!state.rows || !state.cols) {
          alert("먼저 자리를 생성하세요.");
          return;
        }
        if (!state.mode) {
          alert("학생 입력 방식을 선택하세요.");
          return;
        }

        const seats = getActiveSeats();
        const seatCount = seats.length;
        if (seatCount === 0) {
          alert("사용 가능한 자리가 없습니다.");
          return;
        }

        let students = [];

        if (state.mode === "number") {
          const s = parseInt(document.getElementById("startNumberInput").value, 10);
          const e = parseInt(document.getElementById("endNumberInput").value, 10);
          if (!s || !e || s > e) {
            alert("시작 번호와 끝 번호를 올바르게 입력하세요.");
            return;
          }
          const excludeText = document.getElementById("excludeNumbersInput").value.trim();
          const excludeSet = new Set();
          if (excludeText) {
            excludeText.split(",").forEach(v => {
              const num = parseInt(v.trim(), 10);
              if (!isNaN(num)) excludeSet.add(num);
            });
          }
          for (let n = s; n <= e; n++) {
            if (!excludeSet.has(n)) students.push(String(n));
          }
        } else {
          const text = document.getElementById("namesInput").value.trim();
          if (!text) {
            alert("이름을 입력하세요.");
            return;
          }
          students = text.split(",").map(v => v.trim()).filter(v => v.length > 0);
        }

        if (students.length === 0) {
          alert("학생 목록이 비어 있습니다.");
          return;
        }

        if (students.length !== seatCount) {
          alert("자리 수와 학생 수가 일치하지 않습니다.");
          resetAll();
          return;
        }

        state.students = students.slice();
        state.seatNumbers = {};
        state.assignments = {};
        state.orderedSeats = [];
        state.shuffledStudents = [];
        state.index = 0;
        state.drawing = false;

        document.getElementById("screen-config").classList.remove("active");
        document.getElementById("screen-draw").classList.add("active");
        renderGridTo("seatGridDraw");
        drawStatus.textContent = "먼저 '자리 번호 추첨'을 눌러 주세요.";
        drawLog.innerHTML = "";
      };

      // 자리 번호 추첨
      drawSeatNumbersBtn.onclick = () => {
        const seats = getActiveSeats();
        const n = seats.length;
        if (n === 0) {
          alert("사용 가능한 자리가 없습니다.");
          return;
        }

        const indices = Array.from({ length: n }, (_, i) => i);
        shuffle(indices);

        state.seatNumbers = {};
        for (let i = 0; i < n; i++) {
          const seat = seats[indices[i]];
          const k = seatKey(seat.row, seat.col);
          state.seatNumbers[k] = i + 1;  // 1번~N번
        }
        state.assignments = {};
        state.orderedSeats = [];
        state.shuffledStudents = [];
        state.index = 0;
        state.drawing = false;

        renderGridTo("seatGridDraw");
        drawStatus.textContent = "자리 번호가 부여되었습니다. 이제 '추첨 시작'을 누르세요.";
        drawLog.innerHTML = "";
      };

      // 추첨 시작 (버튼 누를 때마다 한 명씩)
      startDrawBtn.onclick = () => {
        if (Object.keys(state.seatNumbers).length === 0) {
          alert("먼저 자리 번호를 추첨하세요.");
          return;
        }

        // 처음 누를 때: 준비
        if (!state.drawing) {
          const seats = getActiveSeats().map(s => {
            const k = seatKey(s.row, s.col);
            return { ...s, seatNumber: state.seatNumbers[k] };
          }).sort((a, b) => a.seatNumber - b.seatNumber);

          state.orderedSeats = seats;                   // seatNumber 1,2,3,... 순
          state.shuffledStudents = shuffle(state.students.slice());  // 학생 순서 섞기
          state.index = 0;
          state.drawing = true;
          drawLog.innerHTML = "";
          drawStatus.textContent = "추첨을 시작합니다. 버튼을 누를 때마다 한 명씩 배정됩니다.";
        }

        if (state.index >= state.shuffledStudents.length) {
          drawStatus.textContent = "모든 학생 배정이 완료되었습니다.";
          showFinalModal();
          return;
        }

        const student = state.shuffledStudents[state.index];   // 이번에 뽑힌 학생
        const seat = state.orderedSeats[state.index];          // seatNumber = index+1 인 자리
        const k = seatKey(seat.row, seat.col);

        // 이 자리의 "번호"를 "학생"으로 교체
        state.assignments[k] = student;

        renderGridTo("seatGridDraw");

        // 로그: "N번 자리: 학생"
        const line = document.createElement("div");
        line.className = "draw-log-line";
        line.textContent = `${seat.seatNumber}번 자리: ${student}`;
        drawLog.appendChild(line);
        const logBox = document.querySelector(".draw-log-container");
        logBox.scrollTop = logBox.scrollHeight;

        state.index++;

        if (state.index === state.shuffledStudents.length) {
          drawStatus.textContent = "모든 학생 배정이 완료되었습니다.";
          showFinalModal();
        } else {
          drawStatus.textContent = `${state.index}명 배정 완료. 계속 진행하세요.`;
        }
      };

      // 모달 닫기
      closeFinalModalBtn.onclick = () => {
        finalModal.classList.add("hidden");
      };
      finalModal.onclick = e => {
        if (e.target === finalModal) finalModal.classList.add("hidden");
      };

      resetAll();
    });
  </script>
</body>
</html>
