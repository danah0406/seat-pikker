<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>자리 뽑기 시스템</title>
  <style>
    :root {
      --seat-ratio-w: 5;
      --seat-ratio-h: 3;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f7;
      min-height: 100vh;
    }

    h1 { margin: 0 0 16px; font-size: 24px; }
    h2 { margin: 0 0 8px; font-size: 20px; }

    .section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    label { margin: 4px 0; display: inline-block; }

    input, textarea {
      padding: 4px 6px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    button {
      margin-top: 8px;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #0070f3;
      background: #0070f3;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /** 자리 칸 — 크기 자동 확장 **/
    .seat {
      width: 100%;
      aspect-ratio: var(--seat-ratio-w) / var(--seat-ratio-h);
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
    }

    .seat.disabled { cursor: default; }
    .seat.excluded { background: #eee; border-style: dashed; color: #888; }
    .seat.assigned { background: #ffe08a; border-color: #f2b100; font-weight: bold; }

    .grid { display: grid; gap: 4px; margin-top: 12px; }

    .radio-group { margin: 8px 0; }
    .info { font-size: 13px; color: #666; }
    .hidden { display: none; }
    .screen { display: none; }
    .screen.active { display: block; }
    .status-text { margin: 8px 0; min-height: 20px; }

    /** 레이아웃 7:3 **/
    .layout-two-columns {
      display: grid;
      grid-template-columns: 7fr 3fr;
      gap: 24px;
      min-height: calc(100vh - 80px);
    }

    /** 오른쪽 패널 **/
    .draw-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .draw-log-container {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      margin-top: 16px;
      height: 300px;
      overflow-y: auto;
    }

    .draw-log-title { font-weight: bold; margin-bottom: 4px; }
    .draw-log-line { margin: 2px 0; }

    /** 모달 **/
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.hidden { display: none; }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    }
  </style>
</head>
<body>

  <h1>자리 뽑기 시스템</h1>

  <!-- 설정 화면 -->
  <div id="screen-config" class="screen active">
    <div class="section">
      <h2>1. 자리 설정</h2>
      <label>행 수: <input type="number" id="rowsInput" min="1" value="4"></label>
      &nbsp;&nbsp;
      <label>열 수: <input type="number" id="colsInput" min="1" value="5"></label>
      <br>
      <button id="generateSeatsBtn">자리 생성</button>
      <div class="info">생성된 자리 칸을 클릭하면 제외할 수 있습니다.</div>
      <div id="seatGridConfig" class="grid"></div>
    </div>

    <div class="section">
      <h2>2. 학생 입력하기</h2>

      <div class="radio-group">
        <label><input type="radio" name="studentMode" value="number"> 번호로 뽑기</label>
        &nbsp;&nbsp;
        <label><input type="radio" name="studentMode" value="name"> 이름으로 뽑기</label>
      </div>

      <div id="studentNumberSection" class="hidden">
        <label>시작 번호: <input type="number" id="startNumberInput"></label>
        &nbsp;
        <label>끝 번호: <input type="number" id="endNumberInput"></label>
        <br>
        <label>제외 번호: <input type="text" id="excludeNumbersInput" placeholder="예: 3,7,12"></label>
      </div>

      <div id="studentNameSection" class="hidden">
        <label>이름 리스트(콤마로 구분):</label>
        <textarea id="namesInput"></textarea>
      </div>

      <button id="goToDrawBtn">다음 단계</button>
      <div id="configStatus" class="status-text"></div>
    </div>
  </div>

  <!-- 추첨 화면 -->
  <div id="screen-draw" class="screen">
    <div class="section layout-two-columns">

      <!-- 자리 배치 -->
      <div>
        <h2>3. 자리 배치</h2>
        <div id="seatGridDraw" class="grid"></div>
      </div>

      <!-- 추첨 -->
      <div class="draw-panel">
        <div>
          <h2>4. 추첨 진행</h2>
          <button id="drawSeatNumbersBtn">자리 번호 추첨</button><br>
          <button id="startDrawBtn" style="margin-top:8px;">추첨 시작</button>
          <div class="info">
            먼저 자리 번호를 랜덤으로 부여한 뒤,<br>
            '추첨 시작'을 누를 때마다 한 명씩 배정됩니다.
          </div>
          <div id="drawStatus" class="status-text"></div>
        </div>

        <div class="draw-log-container">
          <div class="draw-log-title">배정 내역</div>
          <div id="drawLog"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- 최종 자리 배치 모달 -->
  <div id="finalModal" class="modal hidden">
    <div class="modal-content">
      <h2>최종 자리 배치</h2>
      <div id="finalGrid" class="grid"></div>
      <button id="closeFinalModalBtn" style="margin-top:12px;">닫기</button>
    </div>
  </div>

  <script>
    /* 상태 관리 */
    const state = {
      rows:0, cols:0,
      excluded:new Set(),
      students:[],
      mode:null,
      seatNumbers:{},
      assignments:{},
      orderedSeats:[],
      shuffleStudents:[],
      index:0,
      seatAssigned:false,
      drawing:false
    };

    const key=(r,c)=>`${r}-${c}`;
    const shuffle=a=>{ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; };

    /* 자리 활성 좌석 */
    function activeSeats(){
      const arr=[];
      for(let r=0;r<state.rows;r++){
        for(let c=0;c<state.cols;c++){
          if(!state.excluded.has(key(r,c))) arr.push({row:r,col:c});
        }
      }
      return arr;
    }

    /* 그리드 렌더링 (공통) */
    function renderGrid(targetId, seatsData, final=false){
      const grid=document.getElementById(targetId);
      grid.innerHTML="";
      grid.style.gridTemplateColumns=`repeat(${state.cols}, 1fr)`;   /* 핵심: 칸 자동 확장 */

      for(let r=0;r<state.rows;r++){
        for(let c=0;c<state.cols;c++){
          const k=key(r,c);
          const div=document.createElement("div");
          div.className="seat disabled";

          if(state.excluded.has(k)){
            div.classList.add("excluded");
            div.textContent="X";
          } else {
            if(final){
              div.textContent = state.assignments[k] ?? state.seatNumbers[k] ?? "";
              if(state.assignments[k]) div.classList.add("assigned");
            } else {
              const val = seatsData[k];
              if(val){ div.textContent=val; if(state.assignments[k]) div.classList.add("assigned"); }
            }
          }
          grid.appendChild(div);
        }
      }
    }

    /* 자리 생성 화면용 */
    function renderConfigGrid(){
      const grid=document.getElementById("seatGridConfig");
      grid.innerHTML="";
      grid.style.gridTemplateColumns=`repeat(${state.cols}, 1fr)`;

      for(let r=0;r<state.rows;r++){
        for(let c=0;c<state.cols;c++){
          const k=key(r,c);
          const div=document.createElement("div");
          div.className="seat";
          if(state.excluded.has(k)) div.classList.add("excluded");

          div.onclick=()=>{
            if(state.excluded.has(k)){ state.excluded.delete(k); div.classList.remove("excluded"); }
            else{ state.excluded.add(k); div.classList.add("excluded"); }
          };

          grid.appendChild(div);
        }
      }
    }

    /* 최종 모달 */
    function showFinal(){
      renderGrid("finalGrid", state.seatNumbers, true);
      document.getElementById("finalModal").classList.remove("hidden");
    }

    function resetAll(){
      state.rows=0;
      state.cols=0;
      state.excluded=new Set();
      state.students=[];
      state.mode=null;
      state.seatNumbers={};
      state.assignments={};
      state.orderedSeats=[];
      state.shuffleStudents=[];
      state.index=0;
      state.seatAssigned=false;
      state.drawing=false;

      document.getElementById("seatGridConfig").innerHTML="";
      document.getElementById("drawLog").innerHTML="";

      document.getElementById("screen-config").classList.add("active");
      document.getElementById("screen-draw").classList.remove("active");
      document.getElementById("finalModal").classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded",()=>{

      const drawStatus=document.getElementById("drawStatus");
      const drawLog=document.getElementById("drawLog");

      /* 학생 입력 방식 */
      document.querySelectorAll("input[name='studentMode']").forEach(r=>{
        r.onchange=()=>{
          state.mode=r.value;
          document.getElementById("studentNumberSection").classList.toggle("hidden", r.value!=="number");
          document.getElementById("studentNameSection").classList.toggle("hidden", r.value!=="name");
        };
      });

      /* 자리 생성 */
      document.getElementById("generateSeatsBtn").onclick=()=>{
        const rows=parseInt(document.getElementById("rowsInput").value);
        const cols=parseInt(document.getElementById("colsInput").value);

        if(rows<=0||cols<=0){ alert("행, 열을 다시 입력하세요."); return; }

        state.rows=rows;
        state.cols=cols;
        state.excluded=new Set();

        document.getElementById("configStatus").textContent="자리가 생성되었습니다. 제외할 자리를 클릭하세요.";
        renderConfigGrid();
      };

      /* 다음 단계 */
      document.getElementById("goToDrawBtn").onclick=()=>{
        if(!state.rows||!state.cols){ alert("먼저 자리를 생성하세요."); return; }
        if(!state.mode){ alert("학생 입력 방식을 선택하세요."); return; }

        let students=[];
        if(state.mode==="number"){
          const s=parseInt(document.getElementById("startNumberInput").value);
          const e=parseInt(document.getElementById("endNumberInput").value);
          if(!s || !e || s>e){ alert("번호 입력 오류"); return; }

          const exc=document.getElementById("excludeNumbersInput").value;
          const exSet=new Set(exc.split(",").map(v=>parseInt(v.trim())).filter(v=>!isNaN(v)));

          for(let i=s;i<=e;i++){ if(!exSet.has(i)) students.push(String(i)); }
        } else {
          const arr=document.getElementById("namesInput").value.split(",").map(v=>v.trim()).filter(v=>v);
          students=arr;
        }

        const seats=activeSeats();
        if(students.length!==seats.length){
          alert("자리 수와 학생 수가 일치하지 않습니다.");
          resetAll();
          return;
        }

        state.students=students;

        document.getElementById("screen-config").classList.remove("active");
        document.getElementById("screen-draw").classList.add("active");

        renderGrid("seatGridDraw", {});
        drawStatus.textContent="먼저 '자리 번호 추첨'을 눌러주세요.";
        drawLog.innerHTML="";
      };

      /* 자리 번호 추첨 */
      document.getElementById("drawSeatNumbersBtn").onclick=()=>{
        const seats=activeSeats();
        const cnt=seats.length;

        const arr=[...Array(cnt).keys()];
        shuffle(arr);

        state.seatNumbers={};
        for(let i=0;i<cnt;i++){
          const st=seats[arr[i]];
          state.seatNumbers[key(st.row,st.col)] = i+1;
        }

        state.assignments={};
        state.drawing=false;
        state.index=0;

        renderGrid("seatGridDraw", state.seatNumbers);
        drawStatus.textContent="자리 번호가 부여되었습니다. '추첨 시작'을 눌러주세요.";
        drawLog.innerHTML="";
      };

      /* 추첨 시작 */
      document.getElementById("startDrawBtn").onclick=()=>{
        if(Object.keys(state.seatNumbers).length===0){
          alert("먼저 자리 번호를 추첨하세요.");
          return;
        }

        if(!state.drawing){
          const seats=activeSeats().map(s=>({
            ...s,
            seatNumber:state.seatNumbers[key(s.row,s.col)]
          })).sort((a,b)=>a.seatNumber-b.seatNumber);

          state.orderedSeats=seats;
          state.shuffleStudents=shuffle(state.students.slice());
          state.index=0;
          state.drawing=true;
          drawLog.innerHTML="";
          drawStatus.textContent="추첨 시작. 버튼을 누를 때마다 배정됩니다.";
        }

        if(state.index>=state.shuffleStudents.length){
          drawStatus.textContent="모든 학생 배정 완료.";
          showFinal();
          return;
        }

        const stu=state.shuffleStudents[state.index];
        const seat=state.orderedSeats[state.index];
        const k=key(seat.row,seat.col);
        state.assignments[k]=stu;

        renderGrid("seatGridDraw", state.seatNumbers);

        /* 로그 기록 */
        const line=document.createElement("div");
        line.className="draw-log-line";
        line.textContent=`${seat.seatNumber}번 자리: ${stu}`;
        drawLog.appendChild(line);
        const logBox=document.querySelector(".draw-log-container");
        logBox.scrollTop=logBox.scrollHeight;

        state.index++;

        if(state.index===state.shuffleStudents.length){
          drawStatus.textContent="모든 학생 배정 완료.";
          showFinal();
        } else {
          drawStatus.textContent=`${state.index}명 배정됨. 계속 진행하세요.`;
        }
      };

      document.getElementById("closeFinalModalBtn").onclick=()=>{
        document.getElementById("finalModal").classList.add("hidden");
      };

      document.getElementById("finalModal").onclick=e=>{
        if(e.target.id==="finalModal") e.target.classList.add("hidden");
      };

      resetAll();
    });
  </script>
</body>
</html>
